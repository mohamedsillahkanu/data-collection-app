<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Collection Form - Offline Enabled</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background-color: #0d1117;
            color: #e6edf3;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 50px;
            width: 100%;
            max-width: 500px;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2ea043, #58a6ff, #7c3aed);
        }

        .logo-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            gap: 20px;
        }

        .logo-box {
            width: 120px;
            height: 120px;
            background: #21262d;
            border: 2px solid #30363d;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .logo-box:hover {
            border-color: #58a6ff;
            background: rgba(88, 166, 255, 0.05);
            transform: scale(1.05);
        }

        .logo-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #58a6ff;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #8b949e;
            font-size: 14px;
        }

        .login-form-group {
            margin-bottom: 25px;
        }

        .login-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #e6edf3;
            font-size: 14px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .login-input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 14px 24px;
            background: #58a6ff;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: #388bfd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
        }

        .login-error {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid #f85149;
            color: #f85149;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .login-error.show {
            display: block;
            animation: shake 0.5s;
        }

        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 0.6s ease-out;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #58a6ff;
            margin-bottom: 10px;
        }

        .header p {
            color: #8b949e;
            font-size: 18px;
        }

        .logout-container {
            text-align: right;
            margin-bottom: 20px;
        }

        .logout-btn {
            background: transparent;
            color: #8b949e;
            border: 1px solid #30363d;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: #30363d;
            border-color: #58a6ff;
            color: #e6edf3;
        }

        .status-bar {
            background: rgba(13, 17, 23, 0.6);
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            animation: fadeIn 0.6s ease-out 0.2s both;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-indicator.online {
            background: #2ea043;
            box-shadow: 0 0 0 3px rgba(46, 160, 67, 0.3);
        }

        .status-indicator.offline {
            background: #f85149;
            box-shadow: 0 0 0 3px rgba(248, 81, 73, 0.3);
        }

        .status-text {
            font-weight: 600;
            font-size: 14px;
            color: #e6edf3;
        }

        .pending-count {
            background: #58a6ff;
            color: #ffffff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .form-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 40px;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out 0.3s both;
        }

        .form-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2ea043, #58a6ff, #7c3aed);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #e6edf3;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-label .required {
            color: #f85149;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .form-select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #161b22;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .checkbox-label:hover {
            border-color: #58a6ff;
            background: rgba(88, 166, 255, 0.1);
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #58a6ff;
            color: #ffffff;
        }

        .btn-primary:hover:not(:disabled) {
            background: #388bfd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
        }

        .btn-secondary {
            background: transparent;
            color: #8b949e;
            border: 1px solid #30363d;
        }

        .btn-secondary:hover {
            background: #30363d;
            border-color: #58a6ff;
            color: #e6edf3;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #161b22;
            border: 1px solid #30363d;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        }

        .notification.show {
            display: flex;
        }

        .notification.success {
            border-left: 4px solid #2ea043;
        }

        .notification.error {
            border-left: 4px solid #f85149;
        }

        .notification.info {
            border-left: 4px solid #58a6ff;
        }

        .notification-text {
            color: #e6edf3;
            font-size: 14px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @media (max-width: 768px) {
            .login-card {
                padding: 30px;
            }

            .logo-container {
                flex-direction: column;
            }

            .logo-box {
                width: 100px;
                height: 100px;
            }

            .form-card {
                padding: 25px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .status-bar {
                flex-direction: column;
                text-align: center;
            }

            .notification {
                left: 20px;
                right: 20px;
            }

            .logout-container {
                text-align: center;
            }

            .logout-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="logo-container">
                <div class="logo-box">
                    <img src="NMCP.png" alt="Logo Left" class="logo-img">
                </div>
                <div class="logo-box">
                    <img src="ICF-SL.jpg" alt="Logo Right" class="logo-img">
                </div>
            </div>

            <div class="login-header">
                <h1>Welcome</h1>
                <p>Please login to access the data collection form</p>
            </div>

            <div class="login-error" id="loginError">Invalid username or password</div>

            <form id="loginForm">
                <div class="login-form-group">
                    <label class="login-label">Username</label>
                    <input type="text" class="login-input" id="username" required autocomplete="username">
                </div>

                <div class="login-form-group">
                    <label class="login-label">Password</label>
                    <input type="password" class="login-input" id="password" required autocomplete="current-password">
                </div>

                <button type="submit" class="login-btn">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Form Content -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <div class="logout-container">
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>

            <div class="header">
                <h1>Health Data Collection Form</h1>
                <p>Works offline - Data syncs automatically when online</p>
            </div>

            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="statusIndicator"></div>
                    <span class="status-text" id="statusText">Checking...</span>
                </div>
                <div class="status-item">
                    <span style="color: #8b949e; font-size: 14px;">Pending submissions:</span>
                    <span class="pending-count" id="pendingCount">0</span>
                </div>
            </div>

            <div class="form-card">
                <form id="dataForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Region <span class="required">*</span></label>
                            <select class="form-select" name="region" id="regionSelect" required>
                                <option value="">Select region...</option>
                                <option value="Eastern Region">Eastern Region</option>
                                <option value="Northern Region">Northern Region</option>
                                <option value="North West Region">North West Region</option>
                                <option value="Southern Region">Southern Region</option>
                                <option value="Western Area">Western Area</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">District <span class="required">*</span></label>
                            <select class="form-select" name="district" id="districtSelect" required disabled>
                                <option value="">Select region first...</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Chiefdom <span class="required">*</span></label>
                            <select class="form-select" name="chiefdom" id="chiefdomSelect" required disabled>
                                <option value="">Select district first...</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Health Facility <span class="required">*</span></label>
                            <input type="text" class="form-input" name="healthFacility" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Allout <span class="required">*</span></label>
                            <input type="number" class="form-input" name="allout" min="0" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Susp <span class="required">*</span></label>
                            <input type="number" class="form-input" name="susp" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Test <span class="required">*</span></label>
                            <input type="number" class="form-input" name="test" min="0" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Conf <span class="required">*</span></label>
                            <input type="number" class="form-input" name="conf" min="0" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Maltreat <span class="required">*</span></label>
                            <input type="number" class="form-input" name="maltreat" min="0" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Maladm <span class="required">*</span></label>
                            <input type="number" class="form-input" name="maladm" min="0" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Maldth <span class="required">*</span></label>
                        <input type="number" class="form-input" name="maldth" min="0" required>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn btn-secondary" id="clearBtn">Clear Form</button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">Submit Data</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <span class="notification-text" id="notificationText"></span>
    </div>

    <script>
        // ============================================
        // CONFIGURATION - Change these values
        // ============================================
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxWQeuq2PhYYWAK1YXns_Vgc4dIA-NR6J067ECZlEtvkBU-yZZwIIKlK22fnF9638IFhQ/exec';
        const LOGIN_USERNAME = 'admin';
        const LOGIN_PASSWORD = 'password123';

        // Region-District mapping
        const regionDistrictMap = {
            'Eastern Region': [
                'Kailahun District',
                'Kenema District',
                'Kono District'
            ],
            'Northern Region': [
                'Bombali District',
                'Falaba District',
                'Koinadugu District',
                'Tonkolili District'
            ],
            'North West Region': [
                'Kambia District',
                'Karene District',
                'Port Loko District'
            ],
            'Southern Region': [
                'Bo District',
                'Bonthe District',
                'Moyamba District',
                'Pujehun District'
            ],
            'Western Area': [
                'Western Area Urban District',
                'Western Area Rural District'
            ]
        };

        // District-Chiefdom mapping
        const districtChiefdomMap = {
            'Bo District': ['Bo City', 'Badjia Chiefdom', 'Bagbwe Chiefdom', 'Baoma Chiefdom', 'Bargbo Chiefdom', 'Bongor Chiefdom', 'Bumpe Ngao Chiefdom', 'Gbo Chiefdom', 'Jaiama Chiefdom', 'Kakua Chiefdom', 'Komboya Chiefdom', 'Lugbu Chiefdom', 'Niawa Lenga Chiefdom', 'Selenga Chiefdom', 'Tikonko Chiefdom', 'Valunia Chiefdom', 'Wonde Chiefdom'],
            'Bombali District': ['Biriwa Chiefdom', 'Bombali Sebora Chiefdom', 'Bombali Serry Chiefdom', 'Gbanti (Bombali) Chiefdom', 'Gbendembu Chiefdom', 'Kamaranka Chiefdom', 'Magbaimba Ndohahun Chiefdom', 'Makarie Chiefdom', 'Mara Chiefdom', 'Ngowahun Chiefdom', 'Paki Masabong Chiefdom', 'Safroko Limba Chiefdom', 'Makeni City'],
            'Bonthe District': ['Bendu-Cha Chiefdom', 'Bum Chiefdom', 'Dema Chiefdom', 'Imperi Chiefdom', 'Jong Chiefdom', 'Kpanda Kemoh Chiefdom', 'Kwamebai Krim Chiefdom', 'Nongoba Bullom Chiefdom', 'Sittia Chiefdom', 'Sogbini Chiefdom', 'Yawbeko Chiefdom', 'Bonthe Town'],
            'Falaba District': ['Barawa Wollay Chiefdom', 'Delmandugu Chiefdom', 'Dembelia-Sinkunia Chiefdom', 'Folosaba Dembelia Chiefdom', 'Folosaba Kamba Chiefdom', 'Kabelia Chiefdom', 'Kamadugu Yiraia Chiefdom', 'Kulor Saradu Chiefdom', 'Mongo Chiefdom', 'Morifindu Chiefdom', 'Neya Chiefdom', 'Nyedu Chiefdom', 'Sulima Chiefdom'],
            'Kailahun District': ['Dea Chiefdom', 'Jahn Chiefdom', 'Jawei Chiefdom', 'Kissi Kama Chiefdom', 'Kissi Teng Chiefdom', 'Kissi Tongi Chiefdom', 'Luawa Chiefdom', 'Malema Chiefdom', 'Mandu Chiefdom', 'Njaluahun Chiefdom', 'Peje Bongre Chiefdom', 'Peje West Chiefdom', 'Penguia Chiefdom', 'Upper Bambara Chiefdom', 'Yawei Chiefdom'],
            'Kambia District': ['Bramaia Chiefdom', 'Dixon Chiefdom', 'Gbinleh Chiefdom', 'Konimaka Chiefdom', 'Magbema Chiefdom', 'Mambolo Chiefdom', 'Masumgbala Chiefdom', 'Munu Thalla Chiefdom', 'Samu Chiefdom', 'Tonko Limba Chiefdom'],
            'Karene District': ['Buya Chiefdom', 'Dibia Chiefdom', 'Gbanti (Karene) Chiefdom', 'Gormbahun Chiefdom', 'Mafonda Makerembay Chiefdom', 'Romende Chiefdom', 'Safroko Chiefdom', 'Sanda Loko Chiefdom', 'Sanda Magbolonthor Chiefdom', 'Sanda Tendaren Chiefdom', 'Sella Limba Chiefdom', 'Tambaka Simibungie Chiefdom', 'Tambaka Yobangie Chiefdom'],
            'Kenema District': ['Kenema City', 'Dama Chiefdom', 'Dodo Chiefdom', 'Gaura Chiefdom', 'Gorama Mende Chiefdom', 'Kandu Leppiama Chiefdom', 'Koya (Kenema) Chiefdom', 'Langroma Chiefdom', 'Lower Bambara Chiefdom', 'Malegohun Chiefdom', 'Niawa Chiefdom', 'Nomo Chiefdom', 'Nongowa Chiefdom', 'Simbaru Chiefdom', 'Small Bo Chiefdom', 'Tunkia Chiefdom', 'Wandor Chiefdom'],
            'Koinadugu District': ['Diang Chiefdom', 'Gbonkorbor Kayaka Chiefdom', 'Kallian Chiefdom', 'Kamukeh Chiefdom', 'Kasunko Kakellay Chiefdom', 'Nieni Chiefdom', 'Sengbeh Chiefdom', 'Thamiso Chiefdom', 'Wara Wara Bafodia Chiefdom', 'Wara Wara Yagala Chiefdom'],
            'Kono District': ['Koidu New Sembehun City', 'Fiama Chiefdom', 'Gbane Chiefdom', 'Gbane Kandor Chiefdom', 'Gbense Chiefdom', 'Gorama Kono Chiefdom', 'Kamara Chiefdom', 'Lei Chiefdom', 'Mafindor Chiefdom', 'Nimikoro Chiefdom', 'Nimiyama Chiefdom', 'Sandor Chiefdom', 'Soa Chiefdom', 'Tankoro Chiefdom', 'Toli Chiefdom'],
            'Moyamba District': ['Bagruwa Chiefdom', 'Bumpeh Chiefdom', 'Dasse Chiefdom', 'Fakunya Chiefdom', 'Kaiyamba Chiefdom', 'Kamajei Chiefdom', 'Kargboro Chiefdom', 'Kongbora Chiefdom', 'Kori Chiefdom', 'Kowa Chiefdom', 'Lower Banta Chiefdom', 'Ribbi Chiefdom', 'Timdale Chiefdom', 'Upper Banta Chiefdom'],
            'Port Loko District': ['Port Loko City', 'Bake-Loko Chiefdom', 'Bureh Chiefdom', 'Kaffu Bullom Chiefdom', 'Kamasondo Chiefdom', 'Kasseh Chiefdom', 'Koya (Port Loko) Chiefdom', 'Lokomasama Chiefdom', 'Maconteh Chiefdom', 'Maforki Chiefdom', 'Makama Chiefdom', 'Marampa Chiefdom', 'Masimera Chiefdom', 'Tainkatopa Chiefdom'],
            'Pujehun District': ['Barri Chiefdom', 'Galliness Chiefdom', 'Kabonde Chiefdom', 'Kpaka Chiefdom', 'Kpanga Chiefdom', 'Kpanga Krim Chiefdom', 'Makpele Chiefdom', 'Malen Chiefdom', 'Mano Sakrim Chiefdom', 'Peje Chiefdom', 'Perri Chiefdom', 'Soro Gbeima Chiefdom', 'Sowa Chiefdom', 'Yakemoh Kpukumu Krim Chiefdom'],
            'Tonkolili District': ['Dansogoia Chiefdom', 'Gbokolenken Masankong Chiefdom', 'Gbokolenken Mayeppoh Chiefdom', 'Gbokolenken Polie Chiefdom', 'Gbokolenken Yele Chiefdom', 'Kafe Chiefdom', 'Kalantuba Chiefdom', 'Kholifa Mabang Chiefdom', 'Kholifa Mamuntha Chiefdom', 'Kholifa Rowalla Chiefdom', 'Kunike Barina Chiefdom', 'Kunike Fulawusu Chiefdom', 'Kunike Sanda Chiefdom', 'Malal Chiefdom', 'Sambaya Bendugu Chiefdom', 'Simiria Chiefdom', 'Tane Chiefdom', 'Yoni Mabanta Chiefdom', 'Yoni Mamala Chiefdom'],
            'Western Area Rural District': ['Koya Rural Zone', 'Mountain Rural Zone', 'Waterloo Rural Zone', 'York Rural Zone'],
            'Western Area Urban District': ['Central 1 Zone', 'Central 2 Zone', 'East 1 Zone', 'East 2 Zone', 'East 3 Zone', 'West 1 Zone', 'West 2 Zone', 'West 3 Zone']
        };
        // ============================================

        // State variables
        const state = {
            pendingSubmissions: [],
            isOnline: navigator.onLine,
            isLoggedIn: false
        };

        // Initialize
        function init() {
            // Load pending submissions
            const saved = localStorage.getItem('pendingSubmissions');
            if (saved) {
                try {
                    state.pendingSubmissions = JSON.parse(saved);
                } catch (e) {
                    state.pendingSubmissions = [];
                }
            }

            // Check login state
            state.isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            
            if (state.isLoggedIn) {
                showMainContent();
            }

            // Setup event listeners
            setupEventListeners();
        }

        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Main form
            document.getElementById('dataForm').addEventListener('submit', handleFormSubmit);

            // Clear button
            document.getElementById('clearBtn').addEventListener('click', clearForm);

            // Region-District-Chiefdom cascade
            document.getElementById('regionSelect').addEventListener('change', handleRegionChange);
            document.getElementById('districtSelect').addEventListener('change', handleDistrictChange);

            // Online/offline events
            window.addEventListener('online', handleOnlineEvent);
            window.addEventListener('offline', handleOfflineEvent);
        }

        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            if (username === LOGIN_USERNAME && password === LOGIN_PASSWORD) {
                sessionStorage.setItem('isLoggedIn', 'true');
                state.isLoggedIn = true;
                errorDiv.classList.remove('show');
                showMainContent();
            } else {
                errorDiv.classList.add('show');
            }
        }

        function handleLogout() {
            sessionStorage.removeItem('isLoggedIn');
            state.isLoggedIn = false;
            document.getElementById('mainContent').classList.remove('show');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showMainContent() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').classList.add('show');
            updateOnlineStatus();
            updatePendingCount();
            
            // Sync if online and has pending submissions
            if (state.isOnline && state.pendingSubmissions.length > 0) {
                syncPendingSubmissions();
            }
        }

        function handleRegionChange(e) {
            const region = e.target.value;
            const districtSelect = document.getElementById('districtSelect');
            const chiefdomSelect = document.getElementById('chiefdomSelect');
            
            // Clear existing options
            districtSelect.innerHTML = '<option value="">Select district...</option>';
            chiefdomSelect.innerHTML = '<option value="">Select district first...</option>';
            chiefdomSelect.disabled = true;
            
            if (region && regionDistrictMap[region]) {
                // Enable district select
                districtSelect.disabled = false;
                
                // Add districts for selected region
                regionDistrictMap[region].forEach(district => {
                    const option = document.createElement('option');
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            } else {
                // Disable district select if no region selected
                districtSelect.disabled = true;
                districtSelect.innerHTML = '<option value="">Select region first...</option>';
            }
        }

        function handleDistrictChange(e) {
            const district = e.target.value;
            const chiefdomSelect = document.getElementById('chiefdomSelect');
            
            // Clear existing options
            chiefdomSelect.innerHTML = '<option value="">Select chiefdom...</option>';
            
            if (district && districtChiefdomMap[district]) {
                // Enable chiefdom select
                chiefdomSelect.disabled = false;
                
                // Add chiefdoms for selected district
                districtChiefdomMap[district].forEach(chiefdom => {
                    const option = document.createElement('option');
                    option.value = chiefdom;
                    option.textContent = chiefdom;
                    chiefdomSelect.appendChild(option);
                });
            } else {
                // Disable chiefdom select if no district selected
                chiefdomSelect.disabled = true;
                chiefdomSelect.innerHTML = '<option value="">Select district first...</option>';
            }
        }

        function handleOnlineEvent() {
            state.isOnline = true;
            updateOnlineStatus();
            showNotification('Back online - Syncing data...', 'info');
            syncPendingSubmissions();
        }

        function handleOfflineEvent() {
            state.isOnline = false;
            updateOnlineStatus();
            showNotification('You are offline - Data will be saved locally', 'info');
        }

        function updateOnlineStatus() {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (state.isOnline) {
                indicator.className = 'status-indicator online';
                text.textContent = 'Online';
            } else {
                indicator.className = 'status-indicator offline';
                text.textContent = 'Offline';
            }
        }

        function updatePendingCount() {
            document.getElementById('pendingCount').textContent = state.pendingSubmissions.length;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {
                timestamp: new Date().toISOString(),
                region: formData.get('region'),
                district: formData.get('district'),
                chiefdom: formData.get('chiefdom'),
                healthFacility: formData.get('healthFacility'),
                allout: formData.get('allout'),
                susp: formData.get('susp'),
                test: formData.get('test'),
                conf: formData.get('conf'),
                maltreat: formData.get('maltreat'),
                maladm: formData.get('maladm'),
                maldth: formData.get('maldth')
            };

            if (state.isOnline) {
                await submitToServer(data);
            } else {
                saveOffline(data);
            }
        }

        async function submitToServer(data) {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                showNotification('Data submitted successfully', 'success');
                clearForm();
            } catch (error) {
                console.error('Submit error:', error);
                showNotification('Failed to submit - Saved offline', 'error');
                saveOffline(data);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Data';
            }
        }

        function saveOffline(data) {
            state.pendingSubmissions.push(data);
            localStorage.setItem('pendingSubmissions', JSON.stringify(state.pendingSubmissions));
            updatePendingCount();
            showNotification('Data saved offline - Will sync when online', 'info');
            clearForm();
        }

        async function syncPendingSubmissions() {
            if (!state.isOnline || state.pendingSubmissions.length === 0) return;

            showNotification(`Syncing ${state.pendingSubmissions.length} submission(s)...`, 'info');

            const successfulSyncs = [];

            for (let i = 0; i < state.pendingSubmissions.length; i++) {
                try {
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(state.pendingSubmissions[i])
                    });
                    successfulSyncs.push(i);
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error('Sync error:', error);
                    break;
                }
            }

            if (successfulSyncs.length > 0) {
                state.pendingSubmissions = state.pendingSubmissions.filter((_, index) => 
                    !successfulSyncs.includes(index)
                );
                localStorage.setItem('pendingSubmissions', JSON.stringify(state.pendingSubmissions));
                updatePendingCount();
                showNotification(`Successfully synced ${successfulSyncs.length} submission(s)`, 'success');
            }
        }

        function clearForm() {
            document.getElementById('dataForm').reset();
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            
            notification.className = `notification ${type} show`;
            text.textContent = message;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Start the app
        init();
    </script>
</body>
</html>
